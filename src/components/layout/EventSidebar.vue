<template>
  <a-card :bodyStyle="{ padding: '16px' }">
    <a-button type="primary" class="my-2" block @click="openAddCalendarModal">+ T·∫°o S·ª± Ki·ªán M·ªõi</a-button>

    <div class="calendar-section">
      <a-calendar v-model:value="selectedDate" :fullscreen="false" @select="handleDateSelect">
        <template #headerRender="{ value, onChange }">
          <div class="custom-header">
            <a-button type="text" @click="prevMonth(onChange, value)">
              <LeftOutlined />
            </a-button>
            <span class="header-title">
              {{ selectedDate.format("MMMM YYYY") }}
            </span>
            <a-button type="text" @click="nextMonth(onChange, value)">
              <RightOutlined />
            </a-button>
          </div>
        </template>
      </a-calendar>
    </div>

    <div class="mt-5">
      <h2>S·ª± ki·ªán s·∫Øp t·ªõi</h2>
      <p>ƒê·ª´ng b·ªè l·ª° c√°c s·ª± ki·ªán ƒë√£ l√™n l·ªãch</p>
      <a-list :data-source="filteredEvents" bordered>
        <template #renderItem="{ item }">
          <a-list-item>
            <div class="w-full flex items-center justify-between">
              <a-badge :color="item.color" />
              <div class="event-details">
                <strong>{{ item.date }}</strong>
                <p>{{ item.name }}</p>
              </div>
              <a-tag :color="item.color">{{ item.time }}</a-tag>
            </div>
          </a-list-item>
        </template>
      </a-list>
    </div>

    <div class="mt-5">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-semibold">L·ªãch c·ªßa t√¥i</h3>
        <PlusOutlined class="cursor-pointer text-blue-500 text-xl hover:scale-110 transition-transform"
          @click="openAddCalendarModal" />
      </div>

      <a-checkbox-group v-model:value="selectedCalendars" class="flex flex-col gap-2" @change="updateFilteredEvents">
        <!-- L·ªãch c·ªßa t√¥i -->
        <div v-if="myCalendars.length">
          <h4 class="text-sm font-semibold text-gray-500 mb-2">üìå L·ªãch c·ªßa t√¥i</h4>

          <div v-for="(calendar, index) in displayedCalendars" :key="calendar.id"
            class="flex items-center justify-between p-2 rounded-lg transition-all shadow-sm border border-gray-200 hover:shadow-md bg-white"
            :style="{ borderLeft: `4px solid ${calendar.color}` }">

            <div class="flex items-center">
              <span
                :style="{ backgroundColor: calendar.color, width: '10px', height: '10px', borderRadius: '50%', marginRight: '8px' }"></span>
              <!-- H√¨nh tr√≤n nh·ªè -->
              <a-checkbox :value="calendar.id" class="ml-2">
                <span class="text-sm font-medium text-gray-700">{{ calendar.name }}</span>
              </a-checkbox>
            </div>

            <a-dropdown>
              <EllipsisOutlined class="cursor-pointer text-gray-500 text-lg hover:text-black transition" />
              <template #overlay>
                <a-menu>
                  <a-menu-item @click="displayOnly(calendar.id)">Hi·ªÉn th·ªã duy nh·∫•t</a-menu-item>
                  <a-menu-item @click="viewDetails(calendar.id)">Chi ti·∫øt</a-menu-item>
                  <a-menu-item @click="openUpdateCalendar(calendar.id)">Ch·ªânh s·ª≠a</a-menu-item>
                  <a-menu-item @click="deleteCalendar(calendar.id)" style="color: red;">X√≥a</a-menu-item>
                </a-menu>
              </template>
            </a-dropdown>
          </div>
          <div v-if="myCalendars.length > 5" class="flex justify-center mt-2">
            <a-button type="text" @click="showAll = !showAll">
              <template v-if="showAll">
                <CaretUpOutlined />
              </template>
              <template v-else>
                <CaretDownOutlined />
              </template>
            </a-button>
          </div>
        </div>

        <!-- L·ªãch ƒë∆∞·ª£c chia s·∫ª -->
        <div v-if="sharedCalendars.length" class="mt-4">
          <h4 class="text-sm font-semibold text-gray-500 mb-2">üîó L·ªãch ƒë∆∞·ª£c chia s·∫ª</h4>
          <div v-for="(calendar, index) in displayedSharedCalendars" :key="calendar.id"
            class="flex items-center justify-between p-2 rounded-lg transition-all shadow-sm border border-gray-200 hover:shadow-md bg-white"
            :style="{ borderLeft: `5px solid ${calendar.color}` }">

            <div class="flex items-center">
              <span
                :style="{ backgroundColor: calendar.color, width: '10px', height: '10px', borderRadius: '50%', marginRight: '8px' }"></span>
              <a-checkbox :value="calendar.id" class="ml-2">
                <span class="text-sm font-medium text-gray-700">{{ calendar.name }}</span>
              </a-checkbox>
            </div>

            <a-dropdown>
              <EllipsisOutlined class="cursor-pointer text-gray-500 text-lg hover:text-black transition" />
              <template #overlay>
                <a-menu>
                  <a-menu-item @click="displayOnly(calendar.id)">Hi·ªÉn th·ªã duy nh·∫•t</a-menu-item>
                  <a-menu-item @click="viewDetails(calendar.id)">Chi ti·∫øt</a-menu-item>
                  <a-menu-item @click="openUpdateCalendar(calendar.id)">Ch·ªânh s·ª≠a</a-menu-item> <a-menu-item
                    @click="deleteCalendar(calendar.id)" style="color: red;">X√≥a</a-menu-item>
                </a-menu>
              </template>
            </a-dropdown>
          </div>
          <div v-if="sharedCalendars.length > 5" class="flex justify-center mt-2">
            <a-button type="text" @click="showAllShared = !showAllShared">
              <template v-if="showAllShared">
                <CaretUpOutlined />
              </template>
              <template v-else>
                <CaretDownOutlined />
              </template>
            </a-button>
          </div>

        </div>
      </a-checkbox-group>
    </div>

  </a-card>

  <a-modal v-model:open="isModalOpenAddTag" title="Th√™m tag" @ok="handleOk">
    <a-form layout="vertical">
      <a-form-item label="T√™n tag" required>
        <a-input v-model:value="newTagCalendar.name" placeholder="Nh·∫≠p t√™n tag" />
      </a-form-item>
      <a-form-item label="M√†u s·∫Øc (Hex Code)">
        <input type="color" v-model="newTagCalendar.color" class="w-10 h-10 border rounded cursor-pointer" />
      </a-form-item>
      <a-form-item label="M√¥ t·∫£">
        <a-textarea v-model:value="newTagCalendar.description" placeholder="Nh·∫≠p m√¥ t·∫£ tag" :rows="3" />
      </a-form-item>
    </a-form>
  </a-modal>

  <a-modal v-model:open="isModalOpenUpdateTag" title="C·∫≠p nh·∫≠t Tag" @ok="handleUpdateOk">
    <a-form layout="vertical">
      <a-form-item label="T√™n tag" required>
        <a-input v-model:value="selectedTagCalendar.name" placeholder="Nh·∫≠p t√™n tag" />
      </a-form-item>
      <a-form-item label="M√†u s·∫Øc (Hex Code)">
        <input type="color" v-model="selectedTagCalendar.color" class="w-10 h-10 border rounded cursor-pointer" />
      </a-form-item>
      <a-form-item label="M√¥ t·∫£">
        <a-textarea v-model:value="selectedTagCalendar.description" placeholder="Nh·∫≠p m√¥ t·∫£ tag" :rows="3" />
      </a-form-item>

      <a-form-item label="Ng∆∞·ªùi ƒë∆∞·ª£c m·ªùi">
        <a-select v-model:value="selectedTagCalendar.attendees" mode="multiple" label-in-value placeholder="Kh√°ch m·ªùi"
          style="width: 100%" :filter-option="false" :not-found-content="state.fetching ? undefined : null"
          :options="state.data" @search="fetchUser" />
      </a-form-item>

    </a-form>
  </a-modal>

</template>

<script setup>
import {
  LeftOutlined,
  RightOutlined,
  PlusOutlined,
  EllipsisOutlined,
  CaretDownOutlined,
  CaretUpOutlined,
} from "@ant-design/icons-vue";

import dayjs from "dayjs";
import { ref, onMounted, onBeforeUnmount, computed } from "vue";
import { message } from "ant-design-vue";
import { useRouter } from "vue-router";
import axios from "axios";
import { useEchoStore } from "@/stores/echoStore";
import debounce from 'lodash/debounce';


const dirApi = import.meta.env.VITE_API_BASE_URL;
const token = localStorage.getItem('access_token');

const isModalOpenAddTag = ref(false);
const isModalOpenUpdateTag = ref(false);

const newTagCalendar = ref({ name: "", color: "#1890ff", description: "" });
const selectedTagCalendar = ref({ name: "", color: "#1890ff", description: "", shared_user: "" });

const selectedDate = ref(dayjs());
const selectedCalendars = ref([]);
const router = useRouter();

const myCalendars = ref([]);
const sharedCalendars = ref([]);
const filteredEvents = ref([]);
const events = ref([]);

const showAll = ref(false);
const showAllShared = ref(false);


// L·∫•y th√¥ng tin kh√°ch m·ªùi
const state = ref({
  data: [],
  fetching: false
});

let lastFetchId = 0;

const fetchUser = debounce(async (value) => {
  if (!value) {
    state.value.data = [];
    return;
  }

  lastFetchId += 1;
  const fetchId = lastFetchId;

  state.value.fetching = true;

  try {
    const response = await axios.get(`${dirApi}guest?search=${value}`, {
      headers: {
        Authorization: `Bearer ${token}`,
      }
    });

    if (fetchId !== lastFetchId) return;

    state.value.data = response.data.data.map(user => ({
      label: `${user.email}`,
      value: user.id
    }));
  } catch (error) {
    console.error('Error fetching users:', error);
    state.value.data = [];
  } finally {
    state.value.fetching = false;
  }
}, 300);
// K·∫øt th√∫c h√†m l·∫•y th√¥ng tin kh√°ch m·ªùi

// Kh·ªüi t·∫°o echo store
const echoStore = useEchoStore();

const handleDateSelect = (date) => {
  const year = date.format("YYYY");
  const month = date.format("MM");
  const day = date.format("DD");

  console.log("Chuy·ªÉn h∆∞·ªõng t·ªõi:", `/calendar/day/${year}/${month}/${day}`);

  router.push(`/calendar/day/${year}/${month}/${day}`);
};

const updateFilteredEvents = () => {
  filteredEvents.value = events.value.filter((event) =>
    selectedCalendars.value.includes(event.calendarId)
  );
};

const openAddCalendarModal = () => {
  isModalOpenAddTag.value = true;
};


const displayOnly = (calendarId) => {
  selectedCalendars.value = [calendarId];
};

// Gi·ªõi h·∫°n hi·ªÉn th·ªã
const displayedCalendars = computed(() => {
  return showAll.value ? myCalendars.value : myCalendars.value.slice(0, 5);
});

const displayedSharedCalendars = computed(() => {
  return showAllShared.value ? sharedCalendars.value : sharedCalendars.value.slice(0, 5);
});

const fetchCalendars = async () => {
  try {
    const token = localStorage.getItem("access_token");

    const myTagsResponse = axios.get(`${dirApi}tags`, {
      headers: { Authorization: `Bearer ${token}` },
    });

    const sharedTagsResponse = axios.get(`${dirApi}tags/sharedTags`, {
      headers: { Authorization: `Bearer ${token}` },
    });

    const [myTags, sharedTags] = await Promise.all([myTagsResponse, sharedTagsResponse]);

    if (myTags.data.code === 200) {
      myCalendars.value = myTags.data.data;
    } else {
      message.error("Kh√¥ng th·ªÉ l·∫•y danh s√°ch tags c·ªßa b·∫°n");
    }

    if (sharedTags.data.code === 200) {
      sharedCalendars.value = sharedTags.data.data;
    } else {
      message.error("Kh√¥ng th·ªÉ l·∫•y danh s√°ch tags ƒë∆∞·ª£c chia s·∫ª");
    }
  } catch (error) {
    console.error("L·ªói khi l·∫•y danh s√°ch tags:", error);
    message.error("L·ªói k·∫øt n·ªëi ƒë·∫øn server");
  }
};

fetchCalendars();


const handleOk = async () => {
  if (!newTagCalendar.value.name) {
    message.error("Vui l√≤ng nh·∫≠p t√™n tag!");
    return;
  }

  const randomColors = [
    "#FF5733", "#33FF57", "#3357FF", "#F1C40F", "#8E44AD",
    "#E74C3C", "#3498DB", "#2ECC71", "#9B59B6", "#1ABC9C",
  ];

  if (!newTagCalendar.value.color) {
    newTagCalendar.value.color = randomColors[Math.floor(Math.random() * randomColors.length)];
  }

  try {
    const response = await axios.post(`${dirApi}tags`,
      {
        name: newTagCalendar.value.name,
        description: newTagCalendar.value.description,
        color_code: newTagCalendar.value.color,
        shared_user: [],
      },
      {
        headers: {
          Authorization: `Bearer ${localStorage.getItem("access_token")}`,
        },
      }
    );

    if (response.status === 201) {
      myCalendars.value.push(response.data.data);
      console.log("Tag ƒë√£ ƒë∆∞·ª£c t·∫°o:", response.data.data);
      updateFilteredEvents();
      message.success(`ƒê√£ th√™m tag: ${newTagCalendar.value.name}`);
      isModalOpenAddTag.value = false;

      newTagCalendar.value = { name: "", color: "#1890ff", description: "" };
    }
  } catch (error) {
    console.error("L·ªói khi th√™m tag:", error); // Log l·ªói chi ti·∫øt
    if (error.response) {
      if (error.response.status === 409) {
        message.error("Tag n√†y ƒë√£ t·ªìn t·∫°i!");
      } else {
        message.error(`L·ªói khi th√™m tag: ${error.response.data.message}`);
      }
    } else {
      message.error("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß!");
    }
  }
};


onBeforeUnmount(() => {
  echoStore.stopListening();
});


const viewDetails = (calendarId) => {
  // console.log("Xem chi ti·∫øt cho calendar ID:", calendarId);
};

const deleteCalendar = async (calendarId) => {

  try {
    const token = localStorage.getItem("access_token");
    const response = await axios.delete(`${dirApi}tags/${calendarId}`, {
      headers: { Authorization: `Bearer ${token}` },
    });

    console.log("X√≥a tag", response.data);

    if (response.data.code === 200) {
      myCalendars.value = myCalendars.value.filter(calendar => calendar.id !== calendarId);
      sharedCalendars.value = sharedCalendars.value.filter(calendar => calendar.id !== calendarId);

      message.success("Tag deleted successfully!");

    } else {
      message.error(response.data.message || "C√≥ l·ªói x·∫£y ra!");
    }
  } catch (error) {
    console.error("L·ªói khi x√≥a tag:", error);
    message.error("Kh√¥ng th·ªÉ x√≥a tag. Vui l√≤ng th·ª≠ l·∫°i.");
  }
};


// Update
const openUpdateCalendar = (calendarId) => {
  const calendar = myCalendars.value.find(cal => cal.id === calendarId);
  if (calendar) {
    selectedTagCalendar.value = {
      id: calendar.id,
      name: calendar.name,
      color: calendar.color_code,
      description: calendar.description,
      shared_user: calendar.shared_user ?? []
    };
    isModalOpenUpdateTag.value = true;
  }
};

const handleUpdateOk = async () => {
  try {
    const oldTag = myCalendars.value.find(tag => tag.id === selectedTagCalendar.value.id);

    if (!selectedTagCalendar.value.color && oldTag) {
      selectedTagCalendar.value.color = oldTag.color_code; // ƒê·ªïi l·∫°i ƒë·ªÉ ƒë·ªìng nh·∫•t key
    }

    const response = await axios.put(
      `${dirApi}tags/${selectedTagCalendar.value.id}`,
      { ...selectedTagCalendar.value, color_code: selectedTagCalendar.value.color }, // Chuy·ªÉn 'color' th√†nh 'color_code'
      {
        headers: { Authorization: `Bearer ${token}` }
      }
    );

    console.log("‚úÖ Ph·∫£n h·ªìi t·ª´ server:", response.data);

    if (response.data.success) {
      message.success("C·∫≠p nh·∫≠t tag th√†nh c√¥ng!");
      isModalOpenUpdateTag.value = false;

      // D√πng d·ªØ li·ªáu t·ª´ API ƒë·ªÉ c·∫≠p nh·∫≠t danh s√°ch, tr√°nh l·ªách d·ªØ li·ªáu
      myCalendars.value = myCalendars.value.map(tag =>
        tag.id === response.data.data.id
          ? response.data.data // C·∫≠p nh·∫≠t theo API response
          : tag
      );
    }
  } catch (error) {
    console.error("‚ùå L·ªói khi c·∫≠p nh·∫≠t tag:", error);
    message.error("L·ªói khi c·∫≠p nh·∫≠t tag!");
  }
};


// L·∫Øng nghe s·ª± ki·ªán real-time
onMounted(() => {
  echoStore.initEcho();
  echoStore.startListening();
});
</script>
