import { defineStore } from "pinia";
import { useSettings } from "@/composables/useSettings";
import { useI18n } from "vue-i18n";
import moment from "moment-timezone";
import { watchEffect } from "vue";
import axios from 'axios';
import { message } from 'ant-design-vue';

export const useSettingsStore = defineStore("settings", {
  state: () => ({
    // üñ• C√†i ƒë·∫∑t giao di·ªán
    displayMode: localStorage.getItem("displayMode") || "dayGridMonth", // L∆∞u ch·∫ø ƒë·ªô xem v√†o localStorage
    showWeekNumbers: false,
    themeMode: "light",

    // C√†i ƒë·∫∑t th·ªùi gian
    timeZone: "Asia/Saigon",
    timeZoneOffset: moment.tz("Asia/Saigon").utcOffset() / 60, 
    timeFormat: localStorage.getItem("timeFormat") || "24h",
    slotDuration: "00:30:00",
    language: localStorage.getItem("appLanguage") || "vi",

    // C√†i ƒë·∫∑t l·ªãch
    titleFormat: { year: "numeric", month: "long" }, // ƒê·ªãnh d·∫°ng ti√™u ƒë·ªÅ l·ªãch
    dayHeaderFormat: { weekday: "long", day: "numeric" }, // ƒê·ªãnh d·∫°ng ng√†y trong c·ªôt
    dateFormat: "YYYY-MM-DD", // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã theo chu·∫©n YYYY-MM-DD
    eventTimeFormat: { hour: "2-digit", minute: "2-digit", hour12: false }, // ƒê·ªãnh d·∫°ng ng√†y trong s·ª± ki·ªán
    initialDate: new Date().toISOString().split("T")[0], // Ng√†y b·∫Øt ƒë·∫ßu
    firstDay: 1, 
    multiMonthYear: false, // Hi·ªÉn th·ªã nhi·ªÅu th√°ng

    // validRange: { start: "2025-01-01", end: "2025-12-31" }, // Gi·ªõi h·∫°n ng√†y

    // C√†i ƒë·∫∑t hi·ªÉn th·ªã nƒÉm d·∫°ng l∆∞·ªõi
    multiMonthMaxColumns: parseInt(localStorage.getItem("multiMonthMaxColumns")) || 3,
    showNonCurrentDates: localStorage.getItem("showNonCurrentDates") === "true",

    // Th√¥ng b√°o & Nh·∫Øc nh·ªü
    enableNotifications: true,
    reminderTime: "10m",

    // S·ª± ki·ªán l·∫∑p l·∫°i
    enableRecurringEvents: true,
    defaultRecurrence: "none",

    calendarRef: null, // L∆∞u tham chi·∫øu ƒë·∫øn FullCalendar

    // C·∫≠p nh·∫≠t ƒë·ªãnh d·∫°ng th·ªùi gian cho c√°c c·ªôt
    columnHeaderFormat: {
      weekday: "long",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit",
      hour12: false
    },

    settings: null,
    loading: false,
  }),

  getters: {
    getCurrentSettings: (state) => state.settings
  },

  actions: {
    // Initialize settings from API response
    initializeFromApi(apiSettings) {
      // Convert API settings to match our store format
      const convertedSettings = {
        user_id: Number(apiSettings.user_id),
        displayMode: apiSettings.display_type || 'dayGridMonth',
        language: apiSettings.language || 'vi',
        timeZone: apiSettings.timezone_code || 'Asia/Saigon',
        timeFormat: apiSettings.hour_format || '24h',
        dateFormat: apiSettings.date_format || 'YYYY-MM-DD',
        firstDay: Number(apiSettings.first) || 1,
        themeMode: apiSettings.theme || 'light',
        titleFormat: apiSettings.tittle_format_option ? JSON.parse(apiSettings.tittle_format_option) : { year: 'numeric', month: 'long' },
        dayHeaderFormat: apiSettings.column_header_format_option ? JSON.parse(apiSettings.column_header_format_option) : { weekday: 'long' },
        showWeekNumbers: Boolean(apiSettings.is_display_dayoff),
        multiMonthMaxColumns: Number(apiSettings.multi_month_max_columns) || 3,
        showNonCurrentDates: Boolean(apiSettings.show_non_current_dates)
      };

      // Update state
      Object.assign(this.$state, convertedSettings);
      
      // Save to localStorage
      this.saveToLocalStorage();
      
      // Update calendar
      this.updateFullCalendar();
    },

    // Save settings to API
    async saveSettings() {
      try {
        const dirApi = import.meta.env.VITE_API_BASE_URL;
        const token = localStorage.getItem('access_token');
        
        // Convert store settings to API format
        const apiSettings = {
          // id: this.id,
          user_id: this.user_id,
          display_type : this.displayMode,
          language: this.language,
          timezone_code: this.timeZone,
          time_format: this.timeFormat,
          first: this.firstDay,
          is_display_dayoff: this.showWeekNumbers,
          column_header_format_option: JSON.stringify(this.dayHeaderFormat),
          date_format: this.dateFormat,
          theme: this.themeMode,
          time_format: this.timeFormat,
          title_format: JSON.stringify(this.titleFormat),
          day_header_format: JSON.stringify(this.dayHeaderFormat),
          multi_month_max_columns: this.multiMonthMaxColumns,
          tittle_format_options: this.titleFormat,
          // show_non_current_dates: this.showNonCurrentDates
        };

        // Call API to update settings with token in header
        const response = await axios.put(`${dirApi}setting/change`, apiSettings, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.data.code === 200) {
          // Save to localStorage
          this.saveToLocalStorage();
          // Update calendar
          this.updateFullCalendar();
          return true;
        }
        return false;
      } catch (error) {
        console.error('Error saving settings:', error);
        return false;
      }
    },

    // Save to localStorage
    saveToLocalStorage() {
      // T·∫°o m·ªôt object m·ªõi ch·ªâ ch·ª©a c√°c thu·ªôc t√≠nh c·∫ßn thi·∫øt
      const settingsToSave = {
        id: this.id,
        user_id: this.user_id,
        displayMode: this.displayMode,
        language: this.language,
        timeZone: this.timeZone,
        timeFormat: this.timeFormat,
        firstDay: this.firstDay,
        titleFormat: this.titleFormat,
        dayHeaderFormat: this.dayHeaderFormat,
        showWeekNumbers: this.showWeekNumbers,
        multiMonthMaxColumns: this.multiMonthMaxColumns,
        showNonCurrentDates: this.showNonCurrentDates
        // Th√™m c√°c thu·ªôc t√≠nh kh√°c n·∫øu c·∫ßn
      };

      // L∆∞u object ƒë√£ l·ªçc v√†o localStorage
      localStorage.setItem('userSettings', JSON.stringify(settingsToSave));
    },

    // Load from localStorage
    loadFromLocalStorage() {
      const savedSettings = localStorage.getItem('userSettings');
      if (savedSettings) {
        const parsedSettings = JSON.parse(savedSettings);
        // Ch·ªâ c·∫≠p nh·∫≠t c√°c thu·ªôc t√≠nh ƒë√£ ƒë∆∞·ª£c l∆∞u
        Object.assign(this.$state, parsedSettings);
      }
    },

    // Update FullCalendar
    updateFullCalendar() {
      if (this.calendarRef && this.calendarRef.getApi) {
        this.calendarRef.getApi().refetchEvents();
      } else {
        console.warn("calendarRef is not available when calling updateFullCalendar");
      }
    },

    // C·∫≠p nh·∫≠t settings
    async updateSettings(settings) {
      try {
        // Call API to update settings
        const response = await fetch('/api/setting/change', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(settings)
        });

        if (!response.ok) {
          throw new Error('Failed to update settings');
        }

        // Update local state with new settings
        Object.assign(this.$state, settings);
        // Save to localStorage
        this.saveToLocalStorage();
        // Update calendar
        this.updateFullCalendar();

        return true;
      } catch (error) {
        console.error('Error updating settings:', error);
        return false;
      }
    },

    // Set default settings
    setDefaultSettings() {
      const defaultSettings = {
        displayMode: 'dayGridMonth',
        showWeekNumbers: false,
        themeMode: 'light',
        timeZone: 'Asia/Saigon',
        language: 'vi',
        firstDay: 1,
        enableRecurringEvents: true,
        reminderTime: '10m',
        showNonCurrentDates: false,
        dayHeaderFormat: {
          weekday: 'long',
          day: 'numeric'
        },
        eventTimeFormat: {
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        }
      };

      this.settings = defaultSettings;
      this.saveToLocalStorage();
    },

    // Clear settings
    clearSettings() {
      this.settings = null;
      localStorage.removeItem('settings');
    },

    updateTimeFormat(newValue) {
      console.log("Updating time format to:", newValue);
      this.timeFormat = newValue;
      
      // C·∫≠p nh·∫≠t ƒë·ªãnh d·∫°ng th·ªùi gian cho s·ª± ki·ªán
      this.eventTimeFormat = {
        hour: "2-digit",
        minute: "2-digit",
        meridiem: newValue === "12h" ? "short" : false,
        hour12: newValue === "12h"
      };

      // C·∫≠p nh·∫≠t ƒë·ªãnh d·∫°ng cho c√°c c·ªôt
      this.columnHeaderFormat = {
        ...this.columnHeaderFormat,
        hour: "2-digit",
        minute: "2-digit",
        meridiem: newValue === "12h" ? "short" : false,
        hour12: newValue === "12h"
      };
      
      // L∆∞u v√†o localStorage
      localStorage.setItem("timeFormat", newValue);
      this.saveToLocalStorage();
      
      // C·∫≠p nh·∫≠t FullCalendar n·∫øu c√≥
      if (this.calendarRef && this.calendarRef.getApi) {
        const calendarApi = this.calendarRef.getApi();
        
        // C·∫≠p nh·∫≠t ƒë·ªãnh d·∫°ng th·ªùi gian cho s·ª± ki·ªán
        calendarApi.setOption('eventTimeFormat', this.eventTimeFormat);
        
        // C·∫≠p nh·∫≠t ƒë·ªãnh d·∫°ng th·ªùi gian cho c√°c khe th·ªùi gian
        calendarApi.setOption('slotLabelFormat', this.eventTimeFormat);
        
        // Bu·ªôc calendar refresh ƒë·ªÉ √°p d·ª•ng thay ƒë·ªïi
        calendarApi.refetchEvents();
      }
    },
    
    toggleTimeFormat() {
      this.timeFormat = this.timeFormat === "24h" ? "12h" : "24h";  
      this.saveToLocalStorage();
      this.updateFullCalendar();
    },    
    changeLanguage(newLang) {
      this.language = newLang;
      localStorage.setItem(
        "userSettings",
        JSON.stringify({ language: newLang })
      );

      const { locale } = useI18n();
      locale.value = newLang; // C·∫≠p nh·∫≠t Vue I18n
    },
    // C·∫≠p nh·∫≠t c√†i ƒë·∫∑t l·ªãch
    updateColumnHeaderFormat(newValue) {
      console.log("Updating column header format:", newValue);
      this.dayHeaderFormat = newValue;
      
      // C·∫≠p nh·∫≠t FullCalendar
      if (this.calendarRef && this.calendarRef.getApi) {
        const calendarApi = this.calendarRef.getApi();
        calendarApi.setOption('dayHeaderFormat', newValue);
        calendarApi.refetchEvents();
      }
      
      this.saveToLocalStorage();
    },
    // ƒê·ªãnh d·∫°ng ti√™u ƒë·ªÅ l·ªãch
    updateTitleFormat(newValue) {
      console.log("Updating title format:", newValue);
      this.titleFormat = newValue;
      
      // C·∫≠p nh·∫≠t FullCalendar
      if (this.calendarRef && this.calendarRef.getApi) {
        const calendarApi = this.calendarRef.getApi();
        calendarApi.setOption('titleFormat', newValue);
        
        // C·∫≠p nh·∫≠t l·∫°i view hi·ªán t·∫°i
        const currentView = calendarApi.view.type;
        calendarApi.changeView(currentView);
        
        // C·∫≠p nh·∫≠t l·∫°i s·ª± ki·ªán
        calendarApi.refetchEvents();
      }
      
      // L∆∞u v√†o localStorage
      const settingsToSave = {
        ...JSON.parse(localStorage.getItem("userSettings") || "{}"),
        titleFormat: newValue
      };
      localStorage.setItem("userSettings", JSON.stringify(settingsToSave));
    },
    setCalendarRef(ref) {
      this.calendarRef = ref;
    },
    
    updateDisplayMode(newMode) {
      this.displayMode = newMode;
      localStorage.setItem("displayMode", newMode); 
    },

    updateSetting(key, value) {
      this[key] = value;
      this.saveToLocalStorage(); // Lu√¥n l∆∞u l·∫°i khi c·∫≠p nh·∫≠t
      this.updateFullCalendar();
    },
  
    updateMultiMonthSettings(columns, showNonCurrent) {
      this.multiMonthMaxColumns = columns;
      this.showNonCurrentDates = showNonCurrent;
      localStorage.setItem("multiMonthMaxColumns", columns);
      localStorage.setItem("showNonCurrentDates", showNonCurrent);
      this.updateFullCalendar();
    },

    setSettings(settings) {
      try {
        const validatedSettings = this.validateAndConvertSettings(settings);
        this.settings = validatedSettings;
        localStorage.setItem('userSettings', JSON.stringify(validatedSettings));
      } catch (error) {
        console.error('Error setting settings:', error);
        this.setDefaultSettings();
      }
    },

    validateAndConvertSettings(settings) {
      return {
        ...settings,
        // C√°c tr∆∞·ªùng c∆° b·∫£n
        id: Number(settings.id) || 0,
        user_id: Number(settings.user_id) || 0,
        
        // Giao di·ªán
        theme: String(settings.theme || 'light'),
        language: String(settings.language || 'en'),
        
        // ƒê·ªãnh d·∫°ng th·ªùi gian
        timezone_code: String(settings.timezone_code || 'UTC'),
        time_format: String(settings.time_format || 'H:mm'),
        date_format: String(settings.date_format || 'Y-m-d'),
        
        // Calendar settings
        displayMode: String(settings.displayMode || 'dayGridMonth'),
        firstDay: Number(settings.firstDay || 1),
        multiMonthMaxColumns: Number(settings.multiMonthMaxColumns || 3),
        
        // Event settings
        enableRecurringEvents: Boolean(settings.enableRecurringEvents ?? true),
        eventTimeFormat: settings.eventTimeFormat || {
          hour: "2-digit",
          minute: "2-digit",
          hour12: false
        },
        
        // Display settings
        showWeekNumbers: Boolean(settings.showWeekNumbers ?? false),
        showNonCurrentDates: Boolean(settings.showNonCurrentDates ?? false),
        
        // Header format
        dayHeaderFormat: settings.dayHeaderFormat || {
          weekday: 'long',
          day: 'numeric'
        },
        
        // Title format
        titleFormat: settings.titleFormat || {
          year: 'numeric',
          month: 'long'
        },
        
        // Reminder settings
        reminderTime: String(settings.reminderTime || '10m'),
        
        // Time zone offset
        timezoneOffset: Number(settings.timezoneOffset || 0)
      };
    },

    // Add method to update settings from login API response
    updateSettingsFromLogin(apiSettings) {
      // Update all settings from API response
      Object.assign(this.$state, apiSettings);
      // Save to localStorage
      this.saveToLocalStorage();
      // Update calendar if needed
      this.updateFullCalendar();
    },
  },
});

// watchEffect(() => {
//   const settingsStore = useSettingsStore();
//   settingsStore.saveToLocalStorage();
// });