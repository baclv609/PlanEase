import { defineStore } from "pinia";
import { useSettings } from "@/composables/useSettings";
import { useI18n } from "vue-i18n";
import moment from "moment-timezone";
import { watchEffect } from "vue";
import axios from 'axios';
import { message } from 'ant-design-vue';

export const useSettingsStore = defineStore("settings", {
  state: () => {
    // Load initial state from localStorage
    const savedSettings = JSON.parse(localStorage.getItem('userSettings') || '{}');
    
    return {
      // üñ• C√†i ƒë·∫∑t giao di·ªán
      displayMode: savedSettings.displayMode || "dayGridMonth",
      showWeekNumbers: savedSettings.showWeekNumbers || false,
      themeMode: savedSettings.themeMode || "light",

      // C√†i ƒë·∫∑t th·ªùi gian
      timeZone: savedSettings.timeZone || "Asia/Saigon",
      timeZoneOffset: savedSettings.timeZoneOffset || moment.tz("Asia/Saigon").utcOffset() / 60,
      timeFormat: savedSettings.timeFormat || "24h",
      slotDuration: savedSettings.slotDuration || "00:30:00",
      language: savedSettings.language || "vi",

      // C√†i ƒë·∫∑t l·ªãch
      titleFormat: savedSettings.titleFormat || { year: "numeric", month: "long" },
      dayHeaderFormat: savedSettings.dayHeaderFormat || { weekday: "long", day: "numeric" },
      dateFormat: savedSettings.dateFormat || "YYYY-MM-DD",
      eventTimeFormat: savedSettings.eventTimeFormat || { hour: "2-digit", minute: "2-digit", hour12: false },
      initialDate: savedSettings.initialDate || new Date().toISOString().split("T")[0],
      firstDay: savedSettings.firstDay || 1,
      multiMonthYear: savedSettings.multiMonthYear || false,

      // C√†i ƒë·∫∑t hi·ªÉn th·ªã nƒÉm d·∫°ng l∆∞·ªõi
      multiMonthMaxColumns: savedSettings.multiMonthMaxColumns || 3,
      showNonCurrentDates: savedSettings.showNonCurrentDates || false,

      // Th√¥ng b√°o & Nh·∫Øc nh·ªü
      enableNotifications: savedSettings.enableNotifications ?? true,
      notificationType: savedSettings.notificationType || 'both',
      reminderTime: savedSettings.reminderTime || '15',

      // S·ª± ki·ªán l·∫∑p l·∫°i
      enableRecurringEvents: savedSettings.enableRecurringEvents ?? true,
      defaultRecurrence: savedSettings.defaultRecurrence || "none",

      calendarRef: null,

      // C·∫≠p nh·∫≠t ƒë·ªãnh d·∫°ng th·ªùi gian cho c√°c c·ªôt
      columnHeaderFormat: savedSettings.columnHeaderFormat || {
        weekday: "long",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      },

      settings: savedSettings.settings || null,
      loading: false,
    };
  },

  getters: {
    getCurrentSettings: (state) => state.settings
  },

  actions: {
    // Initialize settings from API response
    initializeFromApi(apiSettings) {
      const transformedSettings = {
        // C√†i ƒë·∫∑t giao di·ªán
        displayMode: apiSettings.display_type || "dayGridMonth",
        showWeekNumbers: apiSettings.is_display_dayoff ? true : false,
        themeMode: apiSettings.theme || "light",

        // C√†i ƒë·∫∑t th·ªùi gian
        timeZone: apiSettings.timezone_code || "Asia/Saigon",
        timeZoneOffset: moment.tz(apiSettings.timezone_code || "Asia/Saigon").utcOffset() / 60,
        timeFormat: apiSettings.hour_format || "24h",
        slotDuration: "00:30:00",
        language: apiSettings.language || "vi",

        // C√†i ƒë·∫∑t l·ªãch
        titleFormat: apiSettings.tittle_format_options || { year: "numeric", month: "long" },
        dayHeaderFormat: {
          weekday: this.mapWeekdayFormat(apiSettings.column_header_format_option?.weekday) || "long",
          day: apiSettings.column_header_format_option?.day || "numeric",
        },
        dateFormat: apiSettings.date_format || "YYYY-MM-DD",
        eventTimeFormat: {
          hour: apiSettings.hour_format === "24h" ? "2-digit" : "numeric",
          minute: "2-digit",
          hour12: apiSettings.hour_format !== "24h",
        },
        initialDate: new Date().toISOString().split("T")[0],
        firstDay: Number(apiSettings.first) || 1,
        multiMonthYear: false,

        // C√†i ƒë·∫∑t hi·ªÉn th·ªã nƒÉm d·∫°ng l∆∞·ªõi
        multiMonthMaxColumns: Number(apiSettings.multi_month_max_columns) || 3,
        showNonCurrentDates: apiSettings.show_non_current_dates === true,

        // Th√¥ng b√°o & Nh·∫Øc nh·ªü
        enableNotifications: true,
        notificationType: apiSettings.notification_type || "both",
        reminderTime: apiSettings.reminder_time || "15",

        // S·ª± ki·ªán l·∫∑p l·∫°i
        enableRecurringEvents: true,
        defaultRecurrence: "none",

        // C·∫≠p nh·∫≠t ƒë·ªãnh d·∫°ng th·ªùi gian cho c√°c c·ªôt
        columnHeaderFormat: {
          weekday: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          hour12: apiSettings.hour_format !== "24h"
        }
      };

      // Update state
      Object.assign(this.$state, transformedSettings);
      
      // Save to localStorage
      this.saveToLocalStorage();
      
      // Update calendar
      this.updateFullCalendar();
    },

    // Add new method to map weekday format
    mapWeekdayFormat(weekday) {
      const formatMap = {
        'short': 'long',  // Map 'short' to 'long' for select option
        'narrow': 'long',
        'long': 'long'
      };
      return formatMap[weekday] || 'long';
    },

    // Save settings to API
    async saveSettings() {
      try {
        const dirApi = import.meta.env.VITE_API_BASE_URL;
        const token = localStorage.getItem('access_token');
        
        const apiSettings = {
          display_type: this.displayMode, // dayGridMonth, timeGridWeek, timeGridDay, listYear
          language: this.language, // vi, en
          timezone_code: this.timeZone, // Asia/Saigon
          first: this.firstDay, // 1: ch·ªß nh·∫≠t, 2: th·ª© hai, 3: th·ª© ba, 4: th·ª© t∆∞, 5: th·ª© nƒÉm, 6: th·ª© s√°u, 7: th·ª© b·∫£y 
          is_display_dayoff: this.showWeekNumbers ? 1 : 0, // 0: kh√¥ng hi·ªÉn th·ªã, 1: hi·ªÉn th·ªã 
          column_header_format_option: this.dayHeaderFormat, // ƒë·ªãnh d·∫°ng ng√†y trong c·ªôt
          date_format: this.dateFormat, // YYYY-MM-DD
          hour_format: this.timeFormat, // 24h, 12h
          theme: this.themeMode, // light, dark
          notification_type: this.notificationType, // email, notification, both
          tittle_format_options: this.titleFormat, // ƒë·ªãnh d·∫°ng ti√™u ƒë·ªÅ l·ªãch
        };

        const response = await axios.put(`${dirApi}setting/change`, apiSettings, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.data.code === 200) {
          return true;
        }
        
        throw new Error(response.data.message || 'Failed to save settings');
      } catch (error) {
        console.error('Error saving settings:', error);
        throw error; // N√©m l·ªói ƒë·ªÉ component c√≥ th·ªÉ x·ª≠ l√Ω
      }
    },

    // Save to localStorage
    saveToLocalStorage() {
      // T·∫°o m·ªôt object m·ªõi ch·ªâ ch·ª©a c√°c thu·ªôc t√≠nh c·∫ßn thi·∫øt
      const settingsToSave = {
        displayMode: this.displayMode,
        showWeekNumbers: this.showWeekNumbers,
        themeMode: this.themeMode,
        timeZone: this.timeZone,
        timeZoneOffset: this.timeZoneOffset,
        timeFormat: this.timeFormat,
        slotDuration: this.slotDuration,
        language: this.language,
        titleFormat: this.titleFormat,
        dayHeaderFormat: this.dayHeaderFormat,
        dateFormat: this.dateFormat,
        eventTimeFormat: this.eventTimeFormat,
        initialDate: this.initialDate,
        firstDay: this.firstDay,
        multiMonthYear: this.multiMonthYear,
        multiMonthMaxColumns: this.multiMonthMaxColumns,
        showNonCurrentDates: this.showNonCurrentDates,
        enableNotifications: this.enableNotifications,
        notificationType: this.notificationType,
        reminderTime: this.reminderTime,
        enableRecurringEvents: this.enableRecurringEvents,
        defaultRecurrence: this.defaultRecurrence,
        columnHeaderFormat: this.columnHeaderFormat,
        settings: this.settings
      };

      // L∆∞u object ƒë√£ l·ªçc v√†o localStorage
      localStorage.setItem('userSettings', JSON.stringify(settingsToSave));
    },

    // Load from localStorage
    loadFromLocalStorage() {
      const savedSettings = localStorage.getItem('userSettings');
      if (savedSettings) {
        const parsedSettings = JSON.parse(savedSettings);
        // Ch·ªâ c·∫≠p nh·∫≠t c√°c thu·ªôc t√≠nh ƒë√£ ƒë∆∞·ª£c l∆∞u
        Object.assign(this.$state, parsedSettings);
      }
    },

    updateFullCalendar() {
      const calendar = document.querySelector('.fc')?.fullCalendar;
      
      if (calendar) {
        calendar.changeView(this.displayMode);
        
        calendar.refetchEvents();
      }
    },

    // Set default settings
    setDefaultSettings() {
      const defaultSettings = {
        displayMode: 'dayGridMonth',
        showWeekNumbers: false,
        themeMode: 'light',
        timeZone: 'Asia/Saigon',
        language: 'vi',
        firstDay: 1,
        enableRecurringEvents: true,
        reminderTime: '15',
        showNonCurrentDates: false,
        dayHeaderFormat: {
          weekday: 'long',
          day: 'numeric'
        },
        eventTimeFormat: {
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        }
      };

      this.settings = defaultSettings;
      this.saveToLocalStorage();
    },

    // Clear settings
    clearSettings() {
      this.settings = null;
      localStorage.removeItem('settings');
    },

    updateTimeFormat(newValue) {
      console.log("Updating time format to:", newValue);
      this.timeFormat = newValue;
      
      // C·∫≠p nh·∫≠t ƒë·ªãnh d·∫°ng th·ªùi gian cho s·ª± ki·ªán
      this.eventTimeFormat = {
        hour: "2-digit",
        minute: "2-digit",
        meridiem: newValue === "12h" ? "short" : false,
        hour12: newValue === "12h"
      };

      // C·∫≠p nh·∫≠t ƒë·ªãnh d·∫°ng cho c√°c c·ªôt
      this.columnHeaderFormat = {
        ...this.columnHeaderFormat,
        hour: "2-digit",
        minute: "2-digit",
        meridiem: newValue === "12h" ? "short" : false,
        hour12: newValue === "12h"
      };
      
      // L∆∞u v√†o localStorage
      localStorage.setItem("timeFormat", newValue);
      this.saveToLocalStorage();
      
      // C·∫≠p nh·∫≠t FullCalendar n·∫øu c√≥
      if (this.calendarRef && this.calendarRef.getApi) {
        const calendarApi = this.calendarRef.getApi();
        
        // C·∫≠p nh·∫≠t ƒë·ªãnh d·∫°ng th·ªùi gian cho s·ª± ki·ªán
        calendarApi.setOption('eventTimeFormat', this.eventTimeFormat);
        
        // C·∫≠p nh·∫≠t ƒë·ªãnh d·∫°ng th·ªùi gian cho c√°c khe th·ªùi gian
        calendarApi.setOption('slotLabelFormat', this.eventTimeFormat);
        
        // Bu·ªôc calendar refresh ƒë·ªÉ √°p d·ª•ng thay ƒë·ªïi
        calendarApi.refetchEvents();
      }
    },
    
    toggleTimeFormat() {
      this.timeFormat = this.timeFormat === "24h" ? "12h" : "24h";  
      this.saveToLocalStorage();
      this.updateFullCalendar();
    },    
    changeLanguage(newLang) {
      this.language = newLang;
      localStorage.setItem(
        "userSettings",
        JSON.stringify({ language: newLang })
      );

      const { locale } = useI18n();
      locale.value = newLang; // C·∫≠p nh·∫≠t Vue I18n
    },
    // C·∫≠p nh·∫≠t c√†i ƒë·∫∑t l·ªãch
    updateColumnHeaderFormat(newValue) {
      console.log("Updating column header format:", newValue);
      this.dayHeaderFormat = newValue;
      
      // C·∫≠p nh·∫≠t FullCalendar
      if (this.calendarRef && this.calendarRef.getApi) {
        const calendarApi = this.calendarRef.getApi();
        calendarApi.setOption('dayHeaderFormat', newValue);
        calendarApi.refetchEvents();
      }
      
      this.saveToLocalStorage();
    },
    // ƒê·ªãnh d·∫°ng ti√™u ƒë·ªÅ l·ªãch
    updateTitleFormat(newValue) {
      console.log("Updating title format:", newValue);
      this.titleFormat = newValue;
      
      // C·∫≠p nh·∫≠t FullCalendar
      if (this.calendarRef && this.calendarRef.getApi) {
        const calendarApi = this.calendarRef.getApi();
        calendarApi.setOption('titleFormat', newValue);
        
        // C·∫≠p nh·∫≠t l·∫°i view hi·ªán t·∫°i
        const currentView = calendarApi.view.type;
        calendarApi.changeView(currentView);
        
        // C·∫≠p nh·∫≠t l·∫°i s·ª± ki·ªán
        calendarApi.refetchEvents();
      }
      
      // L∆∞u v√†o localStorage
      const settingsToSave = {
        ...JSON.parse(localStorage.getItem("userSettings") || "{}"),
        titleFormat: newValue
      };
      localStorage.setItem("userSettings", JSON.stringify(settingsToSave));
    },
    setCalendarRef(ref) {
      this.calendarRef = ref;
    },
    
    updateDisplayMode(newMode) {
      this.displayMode = newMode;
      localStorage.setItem("displayMode", newMode); 
    },

    updateSetting(key, value) {
      this[key] = value;
      this.saveToLocalStorage(); // Lu√¥n l∆∞u l·∫°i khi c·∫≠p nh·∫≠t
      this.updateFullCalendar();
    },
  
    updateMultiMonthSettings(columns, showNonCurrent) {
      this.multiMonthMaxColumns = columns;
      this.showNonCurrentDates = showNonCurrent;
      localStorage.setItem("multiMonthMaxColumns", columns);
      localStorage.setItem("showNonCurrentDates", showNonCurrent);
      this.updateFullCalendar();
    },

    setSettings(settings) {
      try {
        const validatedSettings = this.validateAndConvertSettings(settings);
        this.settings = validatedSettings;
        localStorage.setItem('userSettings', JSON.stringify(validatedSettings));
      } catch (error) {
        console.error('Error setting settings:', error);
        this.setDefaultSettings();
      }
    },

    validateAndConvertSettings(settings) {
      return {
        ...settings,
        // C√°c tr∆∞·ªùng c∆° b·∫£n
        id: Number(settings.id) || 0,
        user_id: Number(settings.user_id) || 0,
        
        // Giao di·ªán
        theme: String(settings.theme || 'light'),
        language: String(settings.language || 'en'),
        
        // ƒê·ªãnh d·∫°ng th·ªùi gian
        timezone_code: String(settings.timezone_code || 'UTC'),
        time_format: String(settings.time_format || 'H:mm'),
        date_format: String(settings.date_format || 'Y-m-d'),
        
        // Calendar settings
        displayMode: String(settings.displayMode || 'dayGridMonth'),
        firstDay: Number(settings.firstDay || 1),
        multiMonthMaxColumns: Number(settings.multiMonthMaxColumns || 3),
        
        // Event settings
        enableRecurringEvents: Boolean(settings.enableRecurringEvents ?? true),
        eventTimeFormat: settings.eventTimeFormat || {
          hour: "2-digit",
          minute: "2-digit",
          hour12: false
        },
        
        // Display settings
        showWeekNumbers: Boolean(settings.showWeekNumbers ?? false),
        showNonCurrentDates: Boolean(settings.showNonCurrentDates ?? false),
        
        // Header format
        dayHeaderFormat: settings.dayHeaderFormat || {
          weekday: 'long',
          day: 'numeric'
        },
        
        // Title format
        titleFormat: settings.titleFormat || {
          year: 'numeric',
          month: 'long'
        },
        
        // Reminder settings
        reminderTime: String(settings.reminderTime || '15'),
        
        // Time zone offset
        timezoneOffset: Number(settings.timezoneOffset || 0)
      };
    },

    // Add method to update settings from login API response
    updateSettingsFromLogin(apiSettings) {
      // Update all settings from API response
      Object.assign(this.$state, apiSettings);
      // Save to localStorage
      this.saveToLocalStorage();
      // Update calendar if needed
      this.updateFullCalendar();
    },
  },
});

// watchEffect(() => {
//   const settingsStore = useSettingsStore();
//   settingsStore.saveToLocalStorage();
// });